<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Sender - Dark Knight</title>
    <link rel="stylesheet" href="/static/index.css">
</head>
<body>
    <div class="container">
        <!-- ë°°ê²½ ì´ë¯¸ì§€ ë ˆì´ì–´ -->
        <div class="bg-overlay"></div>
        
        <!-- í—¤ë” -->
        <header class="header">
            <h1 class="title">
                <span class="title-main">EMAIL</span>
                <span class="title-divider">/</span>
                <span class="title-sub">SENDER</span>
            </h1>
            <div class="sender-info" id="sender-info">
                <span class="sender-label">ë°œì‹ ì:</span>
                <span class="sender-email" id="sender-email">í™•ì¸ ì¤‘...</span>
            </div>
        </header>

        <!-- ë©”ì¸ í¼ -->
        <main class="main-content">
            <form id="email-form" class="email-form">
                <!-- ìˆ˜ì‹ ì ì…ë ¥ -->
                <div class="form-group">
                    <label for="recipients" class="label">
                        <span class="label-text">ìˆ˜ì‹ ì</span>
                        <span class="label-accent">Recipients</span>
                    </label>
                    <textarea 
                        id="recipients" 
                        name="recipients" 
                        class="textarea recipients-input"
                        placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‰¼í‘œ ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"
                        required
                    ></textarea>
                    <small class="hint">ì—¬ëŸ¬ ì´ë©”ì¼ì€ ì‰¼í‘œ(,) ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„í•˜ì„¸ìš”</small>
                </div>

                <!-- ì œëª© ì…ë ¥ -->
                <div class="form-group">
                    <label for="subject" class="label">
                        <span class="label-text">ì œëª©</span>
                        <span class="label-accent">Subject</span>
                    </label>
                    <input 
                        type="text" 
                        id="subject" 
                        name="subject" 
                        class="input"
                        placeholder="ì´ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                        required
                    >
                </div>

                <!-- ë³¸ë¬¸ ì…ë ¥ (í…ìŠ¤íŠ¸) -->
                <div class="form-group">
                    <label for="body" class="label">
                        <span class="label-text">ë³¸ë¬¸</span>
                        <span class="label-accent">Body</span>
                    </label>
                    <textarea 
                        id="body" 
                        name="body" 
                        class="textarea body-input"
                        placeholder="ì´ë©”ì¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"
                        rows="6"
                        required
                    ></textarea>
                </div>

                <!-- HTML ë³¸ë¬¸ ì…ë ¥ (ì„ íƒì‚¬í•­) -->
                <div class="form-group">
                    <label for="body-html" class="label">
                        <span class="label-text">HTML ë³¸ë¬¸</span>
                        <span class="label-accent">(Optional)</span>
                    </label>
                    <textarea 
                        id="body-html" 
                        name="body-html" 
                        class="textarea html-input"
                        placeholder='<div style="background-color: #1a1a1a; color: #e0e0e0; padding: 20px; font-family: Arial, sans-serif;">
  <h1 style="color: #6a1b9a;">ì•ˆë…•í•˜ì„¸ìš”</h1>
  <p style="font-size: 16px; line-height: 1.6;">ì´ê²ƒì€ HTML ì´ë©”ì¼ì…ë‹ˆë‹¤.</p>
</div>'
                        rows="8"
                    ></textarea>
                    <small class="hint">
                        ğŸ’¡ CSS íŒ: ì¸ë¼ì¸ ìŠ¤íƒ€ì¼(style="...")ì„ ì‚¬ìš©í•˜ì„¸ìš”. 
                        <button type="button" class="hint-link" id="show-html-example" style="background: none; border: none; color: var(--accent-purple-light); cursor: pointer; text-decoration: underline; padding: 0; margin-left: 5px;">ì˜ˆì‹œ ë³´ê¸°</button>
                    </small>
                </div>

                <!-- íŒŒì¼ ì²¨ë¶€ -->
                <div class="form-group">
                    <label for="attachments" class="label">
                        <span class="label-text">íŒŒì¼ ì²¨ë¶€</span>
                        <span class="label-accent">Attachments</span>
                    </label>
                    <div class="file-upload-wrapper">
                        <input 
                            type="file" 
                            id="attachments" 
                            name="attachments" 
                            class="file-input"
                            multiple
                            accept="*/*"
                        >
                        <label for="attachments" class="file-label">
                            <span class="file-label-text">ğŸ“ íŒŒì¼ ì„ íƒ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</span>
                        </label>
                        <div id="file-list" class="file-list"></div>
                    </div>
                    <small class="hint">ìµœëŒ€ íŒŒì¼ í¬ê¸°: 25MB (ì´ë©”ì¼ ì„œë²„ ì œí•œì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)</small>
                </div>

                <!-- ì „ì†¡ ì˜µì…˜ -->
                <div class="form-group options-group">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="bulk-mode" name="bulk-mode" class="checkbox">
                        <label for="bulk-mode" class="checkbox-label">
                            <span class="checkbox-text">ê°œë³„ ì „ì†¡ ëª¨ë“œ</span>
                            <span class="checkbox-hint">ê° ìˆ˜ì‹ ìì—ê²Œ ê°œë³„ì ìœ¼ë¡œ ì „ì†¡</span>
                        </label>
                    </div>
                </div>

                <!-- ì „ì†¡ ë²„íŠ¼ -->
                <div class="button-group">
                    <button type="submit" class="btn btn-primary" id="send-btn">
                        <span class="btn-text">ì „ì†¡</span>
                        <span class="btn-accent">SEND</span>
                    </button>
                    <button type="button" class="btn btn-secondary" id="clear-btn">
                        <span class="btn-text">ì´ˆê¸°í™”</span>
                    </button>
                </div>
            </form>

            <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
            <div id="result-message" class="result-message hidden"></div>
        </main>

    </div>

    <script>
        const form = document.getElementById('email-form');
        const resultMessage = document.getElementById('result-message');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const senderEmail = document.getElementById('sender-email');

        // ë°œì‹ ì ì •ë³´ ë¡œë“œ
        async function loadSenderInfo() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                if (data.from_email && data.from_email !== 'ì„¤ì •ë˜ì§€ ì•ŠìŒ') {
                    senderEmail.textContent = data.from_email;
                    senderEmail.classList.add('configured');
                } else if (data.smtp_username && data.smtp_username !== 'ì„¤ì •ë˜ì§€ ì•ŠìŒ') {
                    senderEmail.textContent = data.smtp_username + ' (ê¸°ë³¸ê°’)';
                    senderEmail.classList.add('default');
                } else {
                    senderEmail.textContent = 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
                    senderEmail.classList.add('not-configured');
                }
            } catch (error) {
                senderEmail.textContent = 'í™•ì¸ ë¶ˆê°€';
                senderEmail.classList.add('error');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°œì‹ ì ì •ë³´ í™•ì¸
        loadSenderInfo();

        // íŒŒì¼ ëª©ë¡ í‘œì‹œ
        const fileInput = document.getElementById('attachments');
        const fileList = document.getElementById('file-list');
        let selectedFiles = [];

        fileInput.addEventListener('change', (e) => {
            selectedFiles = Array.from(e.target.files);
            updateFileList();
        });

        function updateFileList() {
            fileList.innerHTML = '';
            if (selectedFiles.length === 0) {
                return;
            }

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                const fileSize = (file.size / 1024 / 1024).toFixed(2);
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${fileSize} MB</span>
                    <button type="button" class="file-remove" data-index="${index}">Ã—</button>
                `;
                fileList.appendChild(fileItem);
            });

            // íŒŒì¼ ì œê±° ë²„íŠ¼ ì´ë²¤íŠ¸
            fileList.querySelectorAll('.file-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    selectedFiles.splice(index, 1);
                    updateFileList();
                    // input ìš”ì†Œ ì—…ë°ì´íŠ¸
                    const dt = new DataTransfer();
                    selectedFiles.forEach(file => dt.items.add(file));
                    fileInput.files = dt.files;
                });
            });
        }

        // í¼ ì œì¶œ ì²˜ë¦¬
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ìˆ˜ì‹ ì íŒŒì‹±
            const recipientsText = document.getElementById('recipients').value.trim();
            const recipients = recipientsText
                .split(/[,\n]/)
                .map(email => email.trim())
                .filter(email => email.length > 0);

            if (recipients.length === 0) {
                showResult('ìˆ˜ì‹ ì ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            const subject = document.getElementById('subject').value.trim();
            const body = document.getElementById('body').value.trim();
            const bodyHtml = document.getElementById('body-html').value.trim() || null;

            if (!subject) {
                showResult('ì´ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            if (!body && !bodyHtml) {
                showResult('ì´ë©”ì¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            // ì „ì†¡ ë²„íŠ¼ ë¹„í™œì„±í™”
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="btn-text">ì „ì†¡ ì¤‘...</span>';

            try {
                const endpoint = document.getElementById('bulk-mode').checked 
                    ? '/send-bulk' 
                    : '/send-email';
                
                // íŒŒì¼ì´ ìˆëŠ” ê²½ìš° FormData ì‚¬ìš©, ì—†ìœ¼ë©´ JSON ì‚¬ìš©
                let response;
                if (selectedFiles.length > 0) {
                    const formData = new FormData();
                    formData.append('recipients', JSON.stringify(recipients));
                    formData.append('subject', subject);
                    formData.append('body', body);
                    if (bodyHtml) {
                        formData.append('body_html', bodyHtml);
                    }
                    selectedFiles.forEach((file) => {
                        formData.append('attachments', file);
                    });

                    response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    const jsonData = {
                        recipients: recipients,
                        subject: subject,
                        body: body,
                        body_html: bodyHtml
                    };

                    response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(jsonData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    if (endpoint === '/send-bulk') {
                        showResult(
                            `ì „ì†¡ ì™„ë£Œ: ì´ ${data.total}ëª… ì¤‘ ${data.success_count}ëª… ì„±ê³µ, ${data.fail_count}ëª… ì‹¤íŒ¨`,
                            'success'
                        );
                    } else {
                        showResult(data.message, 'success');
                    }
                    form.reset();
                    selectedFiles = [];
                    updateFileList();
                } else {
                    showResult(data.error || 'ì „ì†¡ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                showResult(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span class="btn-text">ì „ì†¡</span><span class="btn-accent">SEND</span>';
            }
        });

        // ì´ˆê¸°í™” ë²„íŠ¼
        clearBtn.addEventListener('click', () => {
            form.reset();
            selectedFiles = [];
            updateFileList();
            resultMessage.classList.add('hidden');
        });

        // HTML ì˜ˆì‹œ ë³´ê¸°
        const showHtmlExample = document.getElementById('show-html-example');
        if (showHtmlExample) {
            showHtmlExample.addEventListener('click', () => {
                const htmlInput = document.getElementById('body-html');
                const example = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        /* ì¼ë¶€ ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì§€ì› */
        body { font-family: Arial, sans-serif; background-color: #0a0a0a; }
    </style>
</head>
<body style="background-color: #0a0a0a; color: #e0e0e0; padding: 20px; font-family: Arial, sans-serif;">
    <div style="max-width: 600px; margin: 0 auto; background-color: #111111; padding: 30px; border: 1px solid #2a2a2a;">
        <h1 style="color: #6a1b9a; font-size: 28px; margin-bottom: 20px; border-bottom: 2px solid #6a1b9a; padding-bottom: 10px;">
            ì•ˆë…•í•˜ì„¸ìš”!
        </h1>
        <p style="color: #e0e0e0; font-size: 16px; line-height: 1.6; margin-bottom: 15px;">
            ì´ê²ƒì€ <strong style="color: #2e7d32;">HTML í˜•ì‹</strong>ì˜ ì´ë©”ì¼ì…ë‹ˆë‹¤.
        </p>
        <div style="background-color: #1a1a1a; padding: 15px; margin: 20px 0; border-left: 3px solid #6a1b9a;">
            <p style="margin: 0; color: #888888;">ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ì„ ì‚¬ìš©í•˜ë©´ ëŒ€ë¶€ë¶„ì˜ ì´ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë””ìì¸ì´ ì ìš©ë©ë‹ˆë‹¤.</p>
        </div>
        <a href="#" style="display: inline-block; background-color: #6a1b9a; color: #ffffff; padding: 12px 24px; text-decoration: none; border-radius: 0; margin-top: 20px;">
            ë²„íŠ¼ ì˜ˆì‹œ
        </a>
    </div>
</body>
</html>`;
                
                if (htmlInput.value.trim() === '') {
                    htmlInput.value = example;
                    showResult('HTML ì˜ˆì‹œê°€ ì…ë ¥ë€ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì •í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”.', 'success');
                } else {
                    if (confirm('í˜„ì¬ ì…ë ¥ëœ ë‚´ìš©ì„ ì˜ˆì‹œë¡œ êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        htmlInput.value = example;
                        showResult('HTML ì˜ˆì‹œë¡œ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    }
                }
            });
        }

        // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
        function showResult(message, type) {
            resultMessage.textContent = message;
            resultMessage.className = `result-message ${type}`;
            resultMessage.classList.remove('hidden');
            
            // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (ì„±ê³µ ì‹œ)
            if (type === 'success') {
                setTimeout(() => {
                    resultMessage.classList.add('hidden');
                }, 5000);
            }
        }
    </script>
</body>
</html>

